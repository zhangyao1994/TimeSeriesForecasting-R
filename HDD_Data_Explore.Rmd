---
title: "HDD Data Exploratory Analytics"
author: "Yao"
date: "May 23, 2018 - May 24, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(scales)
library(ggthemes)
options(scipen = 999)
```

## Clean HDD Demand Data Explorary Analytics

I got the cleaned HDD demand data by CFG, Region, and other attributes from Cinkie. I can use this to jump start the HDD demand forecasting exercise.
```{r load the data}
HDD_data <- read.csv("~/HDD_FY16_FY19M03_Transformed.csv") %>% filter(Fiscal_Yr %in% c('FY17','FY18','FY19'))
head(HDD_data)
```

```{r plot overall HDD_QTY}
# HDD Weekly Sales
p_week <- HDD_data %>% group_by(Fiscal_Wk) %>%
  mutate(Fiscal_Wk_QTY=sum(QTY)) %>%
  ggplot(aes(x=Fiscal_Wk,y=Fiscal_Wk_QTY,group=1, colour=Fiscal_Yr)) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Weekly Sales FY17-FY19M03', x = "Fiscal Week", y = "Part Quantity") + 
  theme_minimal(base_size = 18) + 
  #scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY16W01','FY17W01', 'FY18W01', 'FY19W01')) +
  theme(legend.position = 'none',plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
p_week
# This weekly plot is too detalied to find patterns.

# HDD Monthly Sales
p_month <- HDD_data %>% group_by(Fiscal_Mo) %>%
  mutate(Fiscal_Mo_QTY=sum(QTY)) %>%
  ggplot(aes(x=Fiscal_Mo,y=Fiscal_Mo_QTY,group=1, colour=Fiscal_Yr)) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Monthly Sales FY17-FY19M03', x = "Fiscal Month", y = "Part Quantity") + 
  theme_minimal(base_size = 18) + 
  #scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY16M01','FY17M01', 'FY18M01', 'FY19M01')) +
  theme(legend.position = 'none',plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(label=comma) + expand_limits(y = 0) +
  geom_vline(xintercept = seq(3,39,3), linetype="dashed", color = 'gray')
  # theme(axis.text.x=element_blank())
p_month
# The monthly plot is good to see some patterns.

# HDD Quarterly Sales
temp_quarter <- HDD_data %>% group_by(Fiscal_Qtr) %>%
  mutate(Fiscal_Qtr_QTY=sum(QTY)) 
p_quarter <-
  ggplot(na.omit(temp_quarter), aes(x=Fiscal_Qtr,y=Fiscal_Qtr_QTY,group=1, colour=Fiscal_Yr)) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Quarterly Sales FY17-FY19M03', x = "Fiscal Quarter", y = "Part Quantity") + 
  theme_minimal(base_size = 18) + 
  #scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY16Q1','FY17Q1', 'FY18Q1', 'FY19Q1')) +
  theme(legend.position = 'none',plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
p_quarter
# The quarterly sales might be easier to forecast accurately.

# # HDD Monthly End Date Sales # This is similar to fiscal month.
# p_month_end_date <- HDD_data %>% group_by(Fiscal_Mo_End_Date) %>%
#   mutate(Fiscal_Mo_End_Date_QTY=sum(QTY)) %>%
#   ggplot(aes(x=Fiscal_Mo_End_Date,y=Fiscal_Mo_End_Date_QTY,group=1, colour=Fiscal_Qtr)) +
#   geom_point(size = 2) +
#   geom_line(size = 1.5) +
#   labs(title = 'HDD Monthly End Date Sales FY17-FY19M03', x = "Fiscal Month End Date", y = "Part Quantity") +
#   scale_x_discrete(breaks = c('2/27/2015','1/29/2016','2/3/2017', '2/2/2018')) +
#   theme(axis.text.x=element_blank(),legend.position="none")
# p_month_end_date
# This is not in the right order. Please give it up!
# Also, Fiscal_Wk_End_Date is not in the right order. Please check the right time order.
```

Overall, HDD montly sales increased in Fiscal Year 2016 and become relatively stable after 2017 Q1 with spikes at the end of almost each quarter.
Note that for the 4th quarter, the spike may appear at the first or second month instead of the last month.

```{r plotly, eval=FALSE, include=FALSE}
ggplotly(p_month)
```

```{r by Region}
# HDD Monthly Sales by Region FY17-FY19M03
HDD_data %>% 
  group_by(Region,Fiscal_Mo) %>%
  mutate(Region_Fiscal_Mo_QTY=sum(QTY)) %>%
  ggplot(aes(x=Fiscal_Mo,y=Region_Fiscal_Mo_QTY,group=Region, colour=Region)) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Monthly Sales by Region FY17-FY19M03', x = "Fiscal Month", y = "Part Quantity") + 
  theme_minimal(base_size = 18) + 
  scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY16M01','FY17M01', 'FY18M01', 'FY19M01')) +
  theme(legend.position = 'bottom',plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)

# HDD Quarterly Sales by Region FY17-FY19M03
HDD_data %>% 
  group_by(Region,Fiscal_Qtr) %>%
  mutate(Region_Fiscal_Qtr_QTY=sum(QTY)) %>% na.omit %>%
  ggplot(aes(x=Fiscal_Qtr,y=Region_Fiscal_Qtr_QTY,group=Region, colour=Region)) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Quarterly Sales by Region FY17-FY19M03', x = "Fiscal Quarter", y = "Part Quantity") + 
  theme_minimal(base_size = 18) + 
  scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY16Q1','FY17Q1', 'FY18Q1', 'FY19Q1')) +
  theme(legend.position = 'bottom',plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)

```

By region, 
BRZ has very low quantities;
EMEA increased in fiscal year 2016 and becomes more stable with spikes at the end of each quarter;
AMF and APJ occupy the majoraty of the sales, and they also increased in fiscal year 2016 and becomes more stable with spikes at the end of each quarter.

```{r by Interface_All}
# HDD Monthly Sales by Interface_All FY17-FY19M03
HDD_data %>% 
  group_by(Interface_All,Fiscal_Mo) %>%
  mutate(Interface_All_Fiscal_Mo_QTY=sum(QTY)) %>% na.omit %>%
  ggplot(aes(x=Fiscal_Mo,y=Interface_All_Fiscal_Mo_QTY,group=Interface_All, colour=Interface_All)) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Monthly Sales by Interface_All FY17-FY19M03', x = "Fiscal Month", y = "Part Quantity") + 
  theme_minimal(base_size = 18) + 
  scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY16M01','FY17M01', 'FY18M01', 'FY19M01')) +
  theme(legend.position = 'bottom',plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)

# HDD Quaterly Sales by Interface_All FY17-FY19M03
HDD_data %>% 
  group_by(Interface_All,Fiscal_Qtr) %>%
  mutate(Interface_All_Fiscal_Qtr_QTY=sum(QTY)) %>% na.omit %>%
  ggplot(aes(x=Fiscal_Qtr,y=Interface_All_Fiscal_Qtr_QTY,group=Interface_All, colour=Interface_All)) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Quarterly Sales by Interface_All FY17-FY19M03', x = "Fiscal Quarter", y = "Part Quantity") + 
  theme_minimal(base_size = 18) + 
  scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY16Q1','FY17Q1', 'FY18Q1', 'FY19Q1')) +
  theme(legend.position = 'bottom',plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)

```

By Interface_All,
SAS12G increased a lot after 2016 and becomes more stable with spikes at the end of almost each quarter;
SATA6G increased slowly after 2016 and spikes showed up at the end of almost each quarter;
SAS6G and SATA have very small quantities.


```{r by RPM}
# HDD Monthly Sales by RPM FY17-FY19M03
p <- HDD_data %>% 
  group_by(RPM,Fiscal_Mo) %>%
  mutate(RPM_Fiscal_Mo_QTY=sum(QTY)) %>% na.omit %>%
  ggplot(aes(x=Fiscal_Mo,y=RPM_Fiscal_Mo_QTY,group=factor(RPM), colour=factor(RPM))) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Monthly Sales by RPM FY17-FY19M03', x = "Fiscal Month", y = "Part Quantity", colour ='RPM') + 
  theme_minimal(base_size = 18) + 
  scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY16M01','FY17M01', 'FY18M01', 'FY19M01')) +
  theme(legend.position = 'bottom',plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
p

# HDD Quaterly Sales by RPM FY17-FY19M03
HDD_data %>% 
  group_by(RPM,Fiscal_Qtr) %>%
  mutate(RPM_Fiscal_Qtr_QTY=sum(QTY)) %>% na.omit %>%
  ggplot(aes(x=Fiscal_Qtr,y=RPM_Fiscal_Qtr_QTY,group=factor(RPM), colour=factor(RPM))) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Quarterly Sales by RPM FY17-FY19M03', x = "Fiscal Quarter", y = "Part Quantity", colour ='RPM') + 
  theme_minimal(base_size = 18) + 
  scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY16Q1','FY17Q1', 'FY18Q1', 'FY19Q1')) +
  theme(legend.position = 'bottom',plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
```

By RPM,
15000 does not change a lot;
10000 is the most popular one and has the similar patterns with 10000. They both have spikes at the end of most quarters except the 4th quarter.

```{r plot by Form_Factor}
# HDD Monthly Sales by Form_Factor FY17-FY19M03
p <- HDD_data %>% 
  group_by(Form_Factor,Fiscal_Mo) %>%
  mutate(Form_Factor_Fiscal_Mo_QTY=sum(QTY)) %>% na.omit %>%
  ggplot(aes(x=Fiscal_Mo,y=Form_Factor_Fiscal_Mo_QTY,group=factor(Form_Factor), colour=factor(Form_Factor))) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Monthly Sales by Form_Factor FY17-FY19M03', x = "Fiscal Month", y = "Part Quantity", colour='Form Factor') + 
  theme_minimal(base_size = 18) + 
  scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY16M01','FY17M01', 'FY18M01', 'FY19M01')) +
  theme(legend.position = 'bottom',plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
p

# HDD Quaterly Sales by Form_Factor FY17-FY19M03
HDD_data %>% 
  group_by(Form_Factor,Fiscal_Qtr) %>%
  mutate(Form_Factor_Fiscal_Qtr_QTY=sum(QTY)) %>% na.omit %>%
  ggplot(aes(x=Fiscal_Qtr,y=Form_Factor_Fiscal_Qtr_QTY,group=factor(Form_Factor), colour=factor(Form_Factor))) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Quarterly Sales by Form_Factor FY17-FY19M03', x = "Fiscal Quarter", y = "Part Quantity", colour = 'Form Factor') + 
  theme_minimal(base_size = 18) + 
  scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY16Q1','FY17Q1', 'FY18Q1', 'FY19Q1')) +
  theme(legend.position = 'bottom',plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
```

By Form_Factor,
2.5 became more popular after 2016 and has spikes at the end of most quarters except the last quarter;
3.5 is more stable.

```{r Group Capacity}
# Group Capacity in 5 groups
HDD_data$Capacity_group <- with(HDD_data, ifelse(Capacity <= 500, "<=500GB",
                              ifelse(Capacity <= 1000, "500GB ~ 1TB", 
                                     ifelse(Capacity <= 2000, "1TB ~ 2TB",
                                            ifelse(Capacity <= 4000, "2TB ~ 4TB",">4TB")))))
```

```{r Capacity cluster}
# it seems that it does not work
HDD_data %>% 
  group_by(Capacity,Fiscal_Qtr) %>%
  summarise(Capacity_Fiscal_Qtr_QTY=sum(QTY)) %>% na.omit -> temp
cl <- kmeans(select(temp,Capacity,Capacity_Fiscal_Qtr_QTY),5)
df <- data.frame(CapacityCluster=cl$cluster,temp)
df %>% ggplot(aes(CapacityCluster,Capacity,colour=factor(Capacity))) +
  geom_point()
```


```{r by Capacity}
# HDD Monthly Sales by Capacity FY17-FY19M03
p <- HDD_data %>% 
  group_by(Capacity,Fiscal_Mo) %>%
  mutate(Capacity_Fiscal_Mo_QTY=sum(QTY)) %>% na.omit %>%
  ggplot(aes(x=Fiscal_Mo,y=Capacity_Fiscal_Mo_QTY,group=factor(Capacity), colour=factor(Capacity))) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Monthly Sales by Capacity FY17-FY19M03', x = "Fiscal Month", y = "Part Quantity", colour="Capacity") + 
  theme_minimal(base_size = 18) + 
  scale_color_tableau("tableau20") + 
  scale_x_discrete(breaks = c('FY16M01','FY17M01', 'FY18M01', 'FY19M01')) +
  theme(legend.position = 'bottom',plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
  # facet_wrap(~Capacity)
# ggplotly(p)
p

# HDD Quaterly Sales by Capacity FY17-FY19M03
HDD_data %>% 
  group_by(Capacity,Fiscal_Qtr) %>%
  mutate(Capacity_Fiscal_Qtr_QTY=sum(QTY)) %>% na.omit %>%
  ggplot(aes(x=Fiscal_Qtr,y=Capacity_Fiscal_Qtr_QTY,group=factor(Capacity), colour=factor(Capacity))) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Quarterly Sales by Capacity FY17-FY19M03', x = "Fiscal Quarter", y = "Part Quantity",colour='Capacity') + 
  theme_minimal(base_size = 18) + 
  scale_color_tableau("tableau20") + 
  scale_x_discrete(breaks = c('FY16Q1','FY17Q1', 'FY18Q1', 'FY19Q1')) +
  theme(legend.position = 'bottom',plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0) #+ xlim('FY17Q1','FY19Q1')
  

# Check the distribution of Capacity
# p <- HDD_data %>% ggplot(aes(x=Capacity,fill=QTY)) +
#   geom_histogram()
# ggplotly(p)

# Check the rank of Capacity QTY Sum
HDD_data %>% group_by(Capacity) %>% summarise(Capacity_QTYSum=sum(QTY)) %>% arrange(desc(Capacity_QTYSum))

# HDD Monthly Sales by Capacity_group FY17-FY19M03
p <- HDD_data %>% 
  group_by(Capacity_group,Fiscal_Mo) %>%
  mutate(Capacity_group_Fiscal_Mo_QTY=sum(QTY)) %>% na.omit %>%
  ggplot(aes(x=Fiscal_Mo,y=Capacity_group_Fiscal_Mo_QTY,group=factor(Capacity_group), colour=factor(Capacity_group))) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Quarterly Sales by Capacity_group FY17-FY19M03', x = "Fiscal Quarter", y = "Part Quantity",colour='Capacity Group') + 
  theme_minimal(base_size = 18) + 
  scale_color_tableau("tableau20") + 
  scale_x_discrete(breaks = c('FY16M01','FY17M01', 'FY18M01', 'FY19M01')) +
  theme(legend.position = 'bottom',plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
  # facet_wrap(~Capacity_group)
# ggplotly(p)
p

# HDD Quaterly Sales by Capacity_group FY17-FY19M03
HDD_data %>% 
  group_by(Capacity_group,Fiscal_Qtr) %>%
  mutate(Capacity_group_Fiscal_Qtr_QTY=sum(QTY)) %>% na.omit %>%
  ggplot(aes(x=Fiscal_Qtr,y=Capacity_group_Fiscal_Qtr_QTY,group=factor(Capacity_group), colour=factor(Capacity_group))) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Quarterly Sales by Capacity_group FY17-FY19M03', x = "Fiscal Quarter", y = "Part Quantity",colour='Capacity Group') + 
  theme_minimal(base_size = 18) + 
  scale_color_tableau("tableau20") + 
  scale_x_discrete(breaks = c('FY16Q1','FY17Q1', 'FY18Q1', 'FY19Q1')) +
  theme(legend.position = 'bottom',plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
```

I may need to group "Capacity" in a better way.
Maybe like Cinkie did for SSD. Done on 5/24/2018.

Based on the impact of the above factors, how to forecast?
Quarterly sales forecasting first.
What clusters first?

Sometimes the time series data set that you have may have been collected at regular intervals that were less than one year, for example, monthly or quarterly. In this case, you can specify the number of times that data was collected per year by using the 'frequency' parameter in the ts() function. For monthly time series data, you set frequency=12, while for quarterly time series data, you set frequency=4.

```{r timeseries}
HDD_data %>% group_by(Fiscal_Mo) %>%
  summarise(Fiscal_Mo_QTY=sum(QTY)) -> selecteddata
HDDtimeseries <- ts(selecteddata$Fiscal_Mo_QTY,frequency=12, start=c(2016,1))
HDDtimeseries

plot.ts(HDDtimeseries)

logHDDtimeseries <- log(HDDtimeseries)
plot.ts(logHDDtimeseries)
```

