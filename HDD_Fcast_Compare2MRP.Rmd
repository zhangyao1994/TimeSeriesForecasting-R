---
title: "HDDFcastBaseline"
author: "Yao"
date: "June 8-12, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggthemes)
options(scipen = 999)
library(lubridate)
library(tidyquant)

library(scales) # for percent
```

## Use MRP to establish forecast accuracy baseline

```{r load the data}
# MRP
Fcast_MRP <- read.csv('HDD_FY19_MRP.csv') 
# remove '_CFG' for MRP
Fcast_MRP$CFG = as.factor(substr(Fcast_MRP$CFG,1,nchar(as.character(Fcast_MRP$CFG))-4))

# All mine
Fcast_Yao <- readRDS('All_fcast.rds')

# HDD data from IRIS
load("HDD_QTY_IRIS.RData")
hdd_qty$CFG <- as.factor(hdd_qty$CFG)
```

```{r Match CFG names}
# Weekly data from IRIS data
hdd_qty %>% group_by(CFG, Fiscal_Wk) %>%
  summarise(HDD_QTY = sum(PART_QTY)) %>%
  gather(Model,HDD_QTY,HDD_QTY)-> HDD_Weekly

# Weekly data from MRP
Fcast_MRP %>% group_by(CFG, Fiscal_Wk) %>%
  summarise(MRP_Fcast = sum(value)) %>%
  gather(Model,HDD_QTY,MRP_Fcast)-> HDD_Weekly_MRP

names(Fcast_Yao)[names(Fcast_Yao) == 'All_fcast'] <- 'HDD_QTY'

# join
HDD_Weekly %>% full_join(HDD_Weekly_MRP) %>% 
  full_join(Fcast_Yao) %>% na.omit() -> CFG_fcast.joined
```

```{r Visualize HDD_QTY and Forecast MRP}
CFGgroups <- levels(factor(CFG_fcast.joined$CFG))
len <- length(CFGgroups)

CFG_fcast.joined$HDD_QTY[CFG_fcast.joined$HDD_QTY == 0] <- NA # 0 means no forecast

CFG_fcast.joined %>% spread(Model,HDD_QTY) -> CFG_fcast

CFG_fcast <- na.omit(CFG_fcast) %>% 
  # calculate absolute percent error for MRP
  mutate(ape_MRP = abs((HDD_QTY - MRP_Fcast)/HDD_QTY * 100)) %>%
  # calculate absolute percent error for Prophet
  mutate(ape_Prophet = abs((HDD_QTY - Prophet)/HDD_QTY * 100)) %>%
  # calculate absolute percent error for ARIMA
  mutate(ape_ARIMA = abs((HDD_QTY - ARIMA)/HDD_QTY * 100)) %>%
  # calculate absolute percent error for TBATS
  mutate(ape_TBATS = abs((HDD_QTY - TBATS)/HDD_QTY * 100))

results <- c() # save the error calculation results
for (i in 1:len){
  # HDD Weekly Sales
  temp_data <- filter(CFG_fcast.joined,CFG==CFGgroups[i])# for certain CFG
  
  if (nrow(temp_data)>0) {
    if (1){
      p_week<- temp_data %>%
        ggplot(aes(x=Fiscal_Wk,y=HDD_QTY,group = Model, color = Model)) +
        geom_point(size = 2) +
        geom_line(size = 1.5,alpha=0.8) +
        labs(title = paste(CFGgroups[i],'HDD Weekly Sales'), x = "Fiscal Week", y = "Part Quantity") + 
        theme_minimal(base_size = 14) + 
        scale_color_tableau('tableau10medium') + 
        scale_x_discrete(breaks = c('FY17W01', 'FY18W01', 'FY19W01')) +
        scale_y_continuous(label=comma) + expand_limits(y = 0)
      ggsave(filename = paste(CFGgroups[i],' HDD Weekly Sales',".png",sep = ''), p_week, width=10)
    }
    
    temp_data <- filter(CFG_fcast,CFG==CFGgroups[i])
    
    # MRP
    # Weekly Error Calculation
    mape_wk_MRP<- mean(temp_data$ape_MRP,na.rm = TRUE)
    # 9-week Error Calculation
    MAPE_fcastPeriod_MRP <- abs(sum(temp_data$MRP_Fcast)-sum(temp_data$HDD_QTY))/sum(temp_data$HDD_QTY) * 100
    
    # Prophet
    # Weekly Error Calculation
    mape_wk_Prophet<- mean(temp_data$ape_Prophet,na.rm = TRUE)
    # 9-week Error Calculation
    MAPE_fcastPeriod_Prophet <- abs(sum(temp_data$Prophet)-sum(temp_data$HDD_QTY))/sum(temp_data$HDD_QTY) * 100
    
    # ARIMA
    # Weekly Error Calculation
    mape_wk_ARIMA<- mean(temp_data$ape_ARIMA,na.rm = TRUE)
    # 9-week Error Calculation
    MAPE_fcastPeriod_ARIMA <- abs(sum(temp_data$ARIMA)-sum(temp_data$HDD_QTY))/sum(temp_data$HDD_QTY) * 100
    
    # TBATS
    # Weekly Error Calculation
    mape_wk_TBATS<- mean(temp_data$ape_TBATS,na.rm = TRUE)
    # 9-week Error Calculation
    MAPE_fcastPeriod_TBATS <- abs(sum(temp_data$TBATS)-sum(temp_data$HDD_QTY))/sum(temp_data$HDD_QTY) * 100
    
    results <- rbind(results,c(CFGgroups[i],mape_wk_MRP,MAPE_fcastPeriod_MRP,mape_wk_Prophet,MAPE_fcastPeriod_Prophet,mape_wk_ARIMA,MAPE_fcastPeriod_ARIMA,mape_wk_TBATS,MAPE_fcastPeriod_TBATS))
  }
  else {
    results <- rbind(results,c(CFGgroups[i],rep(NA,8)))
  }
}

dimnames(results)[[2]] <- c('CFG','MAPE_wk_MRP','MAPE_FcastRegion_MRP','MAPE_wk_Prophet','MAPE_FcastRegion_Prophet','MAPE_wk_ARIMA','MAPE_FcastRegion_ARIMA','MAPE_wk_TBATS','MAPE_FcastRegion_TBATS')
results <- data.frame(results)
indx <- c('MAPE_wk_MRP','MAPE_FcastRegion_MRP','MAPE_wk_Prophet','MAPE_FcastRegion_Prophet','MAPE_wk_ARIMA','MAPE_FcastRegion_ARIMA','MAPE_wk_TBATS','MAPE_FcastRegion_TBATS')
results[indx] <- lapply(results[indx], function(x) as.numeric(as.character(x)))

# Attainment Rates
Attainment_Rate_Cal <- function(x) {
  length(which(x<=25))/sum(!is.na(x))
}

# AttainmentRates <- lapply(results[indx],Attainment_Rate_Cal)
# print(AttainmentRates)
# 
# # MAPE
# MAPE <- lapply(results[indx],mean, na.rm = TRUE)
# MAPE_median <- lapply(results[indx],median, na.rm = TRUE)
# print(MAPE)
# print(MAPE_median)

# only considering the same CFGs
results.clean <- na.omit(results)
AttainmentRates <- lapply(results.clean[indx],Attainment_Rate_Cal)
print(AttainmentRates[seq(2,8,2)])

# MAPE
MAPE <- lapply(results.clean[indx],mean, na.rm = TRUE)
MAPE_median <- lapply(results.clean[indx],median, na.rm = TRUE)
print(MAPE[seq(2,8,2)])
print(MAPE_median[seq(2,8,2)])
```

