---
title: "Overall HDD Forecasting"
author: "Yao"
date: "May 29-30, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(scales)
library(ggthemes)
library(ggrepel)
options(scipen = 999)
library(TTR)
library(forecast)
library(tseries)
library(timetk)

# Load Facebook Prophet package
library(Rcpp)
library(prophet)
```

## HDD Forecasting
After exploring some forecast models, I am going to test the cleaned HDD demand data by CFG, Region, and other attributes. I can use this to jump start the HDD demand forecasting exercise.
```{r load the data}
HDD_data <- read.csv("~/HDD_FY16_FY19M03_Transformed_filledAllFiscalQuarter.csv") %>% filter(Fiscal_Yr %in% c('FY17','FY18','FY19'))
```

Facebook Prophet does not work for quarterly forecasting, and I will use ARIMA for quarterly forecasting since the quarterly data meet all the assumptions for the ARIMA model.
```{r ARIMA Quarterly Forecasting with Cross Validation}
HDD_data %>% group_by(Fiscal_Qtr) %>%
  summarise(Fiscal_Qtr_QTY=sum(QTY)) -> temp_quarterly
StartYear <- 2017
HDDQuarterlytimeseries <- ts(temp_quarterly$Fiscal_Qtr_QTY,frequency=4, start=c(StartYear,1))

plot.ts(HDDQuarterlytimeseries, ylim = c(0, 2500000))

# ARIMA with cross validation
forecastPeriodLen = 2

k <- 6
n <- length(HDDQuarterlytimeseries)
mape<- matrix(NA,n-k-1,n-k)
HDDQuarter_Forecast <- matrix(NA,n-k-1,n-k)

freq <- 4

for(i in 1:(n-k-1))
{
  xshort <- window(HDDQuarterlytimeseries,end=2018+i/freq) # start=StartYear+(i-1)/freq # I can use all!
  xnext <- window(HDDQuarterlytimeseries,start=2018+(1+i)/freq,end=2018+(2+i)/freq)
 
  fit <- auto.arima(xshort)
  fcast <- forecast(fit,h=forecastPeriodLen)
  
  mape[i,] <- c(rep(NA,i-1),abs(fcast$mean-xnext)/xnext*100,rep(NA,n-k-(i-1)-forecastPeriodLen))
  HDDQuarter_Forecast[i,] <- c(rep(NA,i-1),fcast$mean,rep(NA,n-k-(i-1)-forecastPeriodLen))
}

colnames(mape) <- c('FY18Q3','FY18Q4','FY19Q1')
mape <- data.frame(mape)
mape$ForecastTimePoint <- c('FY18Q3','FY18Q4')
mape %>% gather(key='Fiscal_Qtr',value="HDD_forecast",FY18Q3:FY19Q1) -> mape

p_mape <- mape %>% 
  ggplot(aes(x=Fiscal_Qtr,y=HDD_forecast,group=ForecastTimePoint, colour=ForecastTimePoint)) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Quarterly Sales Forecast Errors', x = "Fiscal Quarter", y = "MAPE (%)") + 
  # theme_minimal(base_size = 18) + # for slides
  theme_minimal() +
  scale_color_tableau('tableau10medium') + 
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
p_mape

HDDQuarter_Forecast <- data.frame(HDDQuarter_Forecast)
colnames(HDDQuarter_Forecast) <- c('FY18Q3','FY18Q4','FY19Q1')
HDDQuarter_Forecast$ForecastTimePoint <- c('FY18Q3','FY18Q4')
HDDQuarter_Forecast %>% 
  gather(key='Fiscal_Qtr',value="HDD_forecast",FY18Q3:FY19Q1) -> HDDQuarter_Forecast

HDDQuarter_Forecast %>% full_join(temp_quarterly) -> HDDQuarter_Forecast

p_HDDQuarter_Forecast <- HDDQuarter_Forecast %>% 
  ggplot(aes(x=Fiscal_Qtr,y=HDD_forecast,group=ForecastTimePoint, colour=ForecastTimePoint)) +
  geom_point(size = 2) + geom_line(size = 1.5) +
  geom_point(aes(Fiscal_Qtr,Fiscal_Qtr_QTY),size = 2,colour='green') +
  geom_line(aes(Fiscal_Qtr,Fiscal_Qtr_QTY),size = 1.5,colour='green') +
  labs(title = 'HDD Quarterly Sales Forecast vs Ground Truth', x = "Fiscal Quarter", y = "Part Quantity") + 
  # theme_minimal(base_size = 18) + # for slides
  theme_minimal() + 
  scale_color_tableau('tableau10medium') + 
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
p_HDDQuarter_Forecast

```

```{r ETS Monthly Forecasting with Cross Validation}
HDD_data %>% group_by(Fiscal_Mo) %>%
  summarise(Fiscal_Mo_QTY=sum(QTY)) -> temp_monthly

StartYear <- 2017
HDDMonthlytimeseries <- ts(temp_monthly$Fiscal_Mo_QTY,frequency=12, start=c(StartYear,1))

plot.ts(HDDMonthlytimeseries, ylim = c(0, 1000000))

# ARIMA with cross validation
forecastPeriodLen = 6

k <- 18
n <- length(HDDMonthlytimeseries)

mape<- matrix(NA,n-k-forecastPeriodLen+1,n-k)
colnames(mape) <- c('FY18M07','FY18M08','FY18M09','FY18M10','FY18M11','FY18M12','FY19M01','FY19M02','FY19M03')


HDDMonth_Forecast <- matrix(NA,n-k-forecastPeriodLen+1,n-k)
colnames(HDDMonth_Forecast) <-   c('FY18M07','FY18M08','FY18M09','FY18M10','FY18M11','FY18M12','FY19M01','FY19M02','FY19M03')

freq <- 12

for(i in 1:(n-k-forecastPeriodLen+1))
{
  xshort <- window(HDDMonthlytimeseries,end=StartYear+(i-1+k-1)/freq) #start=StartYear+(i-1)/freq,
  xnext <- window(HDDMonthlytimeseries,start=StartYear+(i-1+k)/freq,end=StartYear+(i-1+k+forecastPeriodLen-1)/freq)
 
  fit <- ets(xshort)
  fcast <- forecast(fit,h=forecastPeriodLen)
  
  mape[i,] <- c(rep(NA,i-1),abs(fcast$mean-xnext)/xnext*100,rep(NA,n-k-(i-1)-forecastPeriodLen))
  HDDMonth_Forecast[i,] <- c(rep(NA,i-1),fcast$mean,rep(NA,n-k-(i-1)-forecastPeriodLen))
}

mape <- data.frame(mape)
mape$ForecastTimePoint <- c('FY18M07','FY18M08','FY18M09','FY18M10')
mape %>% gather(key='Fiscal_Mo',value="HDD_forecast",FY18M07:FY19M03) -> mape

p_mape <- mape %>% 
  ggplot(aes(x=Fiscal_Mo,y=HDD_forecast,group=ForecastTimePoint, colour=ForecastTimePoint)) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Monthly Sales Forecast Errors', x = "Fiscal Month", y = "MAPE (%)") + 
  # theme_minimal(base_size = 18) + # for slides
  theme_minimal() +
  scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY18M07', 'FY18M10','FY19M01')) +
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
p_mape

HDDMonth_Forecast <- data.frame(HDDMonth_Forecast)
HDDMonth_Forecast$ForecastTimePoint <- c('FY18M07','FY18M08','FY18M09','FY18M10')
HDDMonth_Forecast %>% 
  gather(key='Fiscal_Mo',value="HDD_forecast",FY18M07:FY19M03) -> HDDMonth_Forecast

HDDMonth_Forecast %>% full_join(temp_monthly) -> HDDMonth_Forecast

p_HDDMonth_Forecast <- HDDMonth_Forecast %>% 
  ggplot(aes(x=Fiscal_Mo,y=HDD_forecast,group=ForecastTimePoint, colour=ForecastTimePoint)) +
  geom_point(size = 2) + geom_line(size = 1.5) +
  geom_point(aes(Fiscal_Mo,Fiscal_Mo_QTY),size = 2,colour='green') + 
  geom_line(aes(Fiscal_Mo,Fiscal_Mo_QTY),size = 1.5,colour='green') +
  labs(title = 'HDD Monthly Sales Forecast vs Ground Truth', x = "Fiscal Month", y = "Part Quantity") + 
  # theme_minimal(base_size = 18) + # for slides
  theme_minimal() + 
  scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY17M01','FY18M01','FY18M07','FY19M01')) +
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
p_HDDMonth_Forecast

```

```{r ARIMA Monthly Forecasting with Cross Validation}
HDD_data %>% group_by(Fiscal_Mo) %>%
  summarise(Fiscal_Mo_QTY=sum(QTY)) -> temp_monthly

StartYear <- 2017
HDDMonthlytimeseries <- ts(temp_monthly$Fiscal_Mo_QTY,frequency=12, start=c(StartYear,1))

plot.ts(HDDMonthlytimeseries, ylim = c(0, 1000000))

# ARIMA with cross validation
forecastPeriodLen = 6

k <- 18
n <- length(HDDMonthlytimeseries)

mape<- matrix(NA,n-k-forecastPeriodLen+1,n-k)
colnames(mape) <- c('FY18M07','FY18M08','FY18M09','FY18M10','FY18M11','FY18M12','FY19M01','FY19M02','FY19M03')


HDDMonth_Forecast <- matrix(NA,n-k-forecastPeriodLen+1,n-k)
colnames(HDDMonth_Forecast) <-   c('FY18M07','FY18M08','FY18M09','FY18M10','FY18M11','FY18M12','FY19M01','FY19M02','FY19M03')

freq <- 12

for(i in 1:(n-k-forecastPeriodLen+1))
{
  xshort <- window(HDDMonthlytimeseries,end=StartYear+(i-1+k-1)/freq) #start=StartYear+(i-1)/freq,
  xnext <- window(HDDMonthlytimeseries,start=StartYear+(i-1+k)/freq,end=StartYear+(i-1+k+forecastPeriodLen-1)/freq)
 
  fit <- auto.arima(xshort)
  fcast <- forecast(fit,h=forecastPeriodLen)
  
  mape[i,] <- c(rep(NA,i-1),abs(fcast$mean-xnext)/xnext*100,rep(NA,n-k-(i-1)-forecastPeriodLen))
  HDDMonth_Forecast[i,] <- c(rep(NA,i-1),fcast$mean,rep(NA,n-k-(i-1)-forecastPeriodLen))
}

mape <- data.frame(mape)
mape$ForecastTimePoint <- c('FY18M07','FY18M08','FY18M09','FY18M10')
mape %>% gather(key='Fiscal_Mo',value="HDD_forecast",FY18M07:FY19M03) -> mape

p_mape <- mape %>% 
  ggplot(aes(x=Fiscal_Mo,y=HDD_forecast,group=ForecastTimePoint, colour=ForecastTimePoint)) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Monthly Sales Forecast Errors', x = "Fiscal Month", y = "MAPE (%)") + 
  # theme_minimal(base_size = 18) + # for slides
  theme_minimal() +
  scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY18M07', 'FY18M10','FY19M01')) +
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
p_mape

HDDMonth_Forecast <- data.frame(HDDMonth_Forecast)
HDDMonth_Forecast$ForecastTimePoint <- c('FY18M07','FY18M08','FY18M09','FY18M10')
HDDMonth_Forecast %>% 
  gather(key='Fiscal_Mo',value="HDD_forecast",FY18M07:FY19M03) -> HDDMonth_Forecast

HDDMonth_Forecast %>% full_join(temp_monthly) -> HDDMonth_Forecast

p_HDDMonth_Forecast <- HDDMonth_Forecast %>% 
  ggplot(aes(x=Fiscal_Mo,y=HDD_forecast,group=ForecastTimePoint, colour=ForecastTimePoint)) +
  geom_point(size = 2) + geom_line(size = 1.5) +
  geom_point(aes(Fiscal_Mo,Fiscal_Mo_QTY),size = 2,colour='green') + 
  geom_line(aes(Fiscal_Mo,Fiscal_Mo_QTY),size = 1.5,colour='green') +
  labs(title = 'HDD Monthly Sales Forecast vs Ground Truth', x = "Fiscal Month", y = "Part Quantity") + 
  # theme_minimal(base_size = 18) + # for slides
  theme_minimal() + 
  scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY17M01','FY18M01','FY18M07','FY19M01')) +
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
p_HDDMonth_Forecast

```

```{r TBATS Monthly Forecasting with Cross Validation}
HDD_data %>% group_by(Fiscal_Mo) %>%
  summarise(Fiscal_Mo_QTY=sum(QTY)) -> temp_monthly

StartYear <- 2017
HDDMonthlytimeseries <- ts(temp_monthly$Fiscal_Mo_QTY,frequency=12, start=c(StartYear,1))

plot.ts(HDDMonthlytimeseries, ylim = c(0, 1000000))

# ARIMA with cross validation
forecastPeriodLen = 6

k <- 18
n <- length(HDDMonthlytimeseries)

mape<- matrix(NA,n-k-forecastPeriodLen+1,n-k)
colnames(mape) <- c('FY18M07','FY18M08','FY18M09','FY18M10','FY18M11','FY18M12','FY19M01','FY19M02','FY19M03')


HDDMonth_Forecast <- matrix(NA,n-k-forecastPeriodLen+1,n-k)
colnames(HDDMonth_Forecast) <-   c('FY18M07','FY18M08','FY18M09','FY18M10','FY18M11','FY18M12','FY19M01','FY19M02','FY19M03')

freq <- 12

for(i in 1:(n-k-forecastPeriodLen+1))
{
  xshort <- window(HDDMonthlytimeseries,end=StartYear+(i-1+k-1)/freq) #start=StartYear+(i-1)/freq,
  xnext <- window(HDDMonthlytimeseries,start=StartYear+(i-1+k)/freq,end=StartYear+(i-1+k+forecastPeriodLen-1)/freq)
 
  fit <- tbats(xshort)
  # fit <- tslm(xshort~ trend + season)
  fcast <- forecast(fit,h=forecastPeriodLen)
  
  mape[i,] <- c(rep(NA,i-1),abs(fcast$mean-xnext)/xnext*100,rep(NA,n-k-(i-1)-forecastPeriodLen))
  HDDMonth_Forecast[i,] <- c(rep(NA,i-1),fcast$mean,rep(NA,n-k-(i-1)-forecastPeriodLen))
}

mape <- data.frame(mape)
mape$ForecastTimePoint <- c('FY18M07','FY18M08','FY18M09','FY18M10')
mape %>% gather(key='Fiscal_Mo',value="HDD_forecast",FY18M07:FY19M03) -> mape

p_mape <- mape %>% 
  ggplot(aes(x=Fiscal_Mo,y=HDD_forecast,group=ForecastTimePoint, colour=ForecastTimePoint)) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Monthly Sales Forecast Errors', x = "Fiscal Month", y = "MAPE (%)") + 
  # theme_minimal(base_size = 18) + # for slides
  theme_minimal() +
  scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY18M07', 'FY18M10','FY19M01')) +
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
p_mape

HDDMonth_Forecast <- data.frame(HDDMonth_Forecast)
HDDMonth_Forecast$ForecastTimePoint <- c('FY18M07','FY18M08','FY18M09','FY18M10')
HDDMonth_Forecast %>% 
  gather(key='Fiscal_Mo',value="HDD_forecast",FY18M07:FY19M03) -> HDDMonth_Forecast

HDDMonth_Forecast %>% full_join(temp_monthly) -> HDDMonth_Forecast

p_HDDMonth_Forecast <- HDDMonth_Forecast %>% 
  ggplot(aes(x=Fiscal_Mo,y=HDD_forecast,group=ForecastTimePoint, colour=ForecastTimePoint)) +
  geom_point(size = 2) + geom_line(size = 1.5) +
  geom_point(aes(Fiscal_Mo,Fiscal_Mo_QTY),size = 2,colour='green') + 
  geom_line(aes(Fiscal_Mo,Fiscal_Mo_QTY),size = 1.5,colour='green') +
  labs(title = 'HDD Monthly Sales Forecast vs Ground Truth', x = "Fiscal Month", y = "Part Quantity") + 
  # theme_minimal(base_size = 18) + # for slides
  theme_minimal() + 
  scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY17M01','FY18M01','FY18M07','FY19M01')) +
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
p_HDDMonth_Forecast

```
```{r TSLM Monthly Forecasting with Cross Validation}
HDD_data %>% group_by(Fiscal_Mo) %>%
  summarise(Fiscal_Mo_QTY=sum(QTY)) -> temp_monthly

StartYear <- 2017
HDDMonthlytimeseries <- ts(temp_monthly$Fiscal_Mo_QTY,frequency=12, start=c(StartYear,1))

plot.ts(HDDMonthlytimeseries, ylim = c(0, 1000000))

# ARIMA with cross validation
forecastPeriodLen = 6

k <- 18
n <- length(HDDMonthlytimeseries)

mape<- matrix(NA,n-k-forecastPeriodLen+1,n-k)
colnames(mape) <- c('FY18M07','FY18M08','FY18M09','FY18M10','FY18M11','FY18M12','FY19M01','FY19M02','FY19M03')


HDDMonth_Forecast <- matrix(NA,n-k-forecastPeriodLen+1,n-k)
colnames(HDDMonth_Forecast) <-   c('FY18M07','FY18M08','FY18M09','FY18M10','FY18M11','FY18M12','FY19M01','FY19M02','FY19M03')

freq <- 12

for(i in 1:(n-k-forecastPeriodLen+1))
{
  xshort <- window(HDDMonthlytimeseries,end=StartYear+(i-1+k-1)/freq) #start=StartYear+(i-1)/freq,
  xnext <- window(HDDMonthlytimeseries,start=StartYear+(i-1+k)/freq,end=StartYear+(i-1+k+forecastPeriodLen-1)/freq)
 
  # fit <- auto.arima(xshort)
  fit <- tslm(xshort~ trend + season)
  fcast <- forecast(fit,h=forecastPeriodLen)
  
  mape[i,] <- c(rep(NA,i-1),abs(fcast$mean-xnext)/xnext*100,rep(NA,n-k-(i-1)-forecastPeriodLen))
  HDDMonth_Forecast[i,] <- c(rep(NA,i-1),fcast$mean,rep(NA,n-k-(i-1)-forecastPeriodLen))
}

mape <- data.frame(mape)
mape$ForecastTimePoint <- c('FY18M07','FY18M08','FY18M09','FY18M10')
mape %>% gather(key='Fiscal_Mo',value="HDD_forecast",FY18M07:FY19M03) -> mape

p_mape <- mape %>% 
  ggplot(aes(x=Fiscal_Mo,y=HDD_forecast,group=ForecastTimePoint, colour=ForecastTimePoint)) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Monthly Sales Forecast Errors', x = "Fiscal Month", y = "MAPE (%)") + 
  # theme_minimal(base_size = 18) + # for slides
  theme_minimal() +
  scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY18M07', 'FY18M10','FY19M01')) +
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
p_mape

HDDMonth_Forecast <- data.frame(HDDMonth_Forecast)
HDDMonth_Forecast$ForecastTimePoint <- c('FY18M07','FY18M08','FY18M09','FY18M10')
HDDMonth_Forecast %>% 
  gather(key='Fiscal_Mo',value="HDD_forecast",FY18M07:FY19M03) -> HDDMonth_Forecast

HDDMonth_Forecast %>% full_join(temp_monthly) -> HDDMonth_Forecast

p_HDDMonth_Forecast <- HDDMonth_Forecast %>% 
  ggplot(aes(x=Fiscal_Mo,y=HDD_forecast,group=ForecastTimePoint, colour=ForecastTimePoint)) +
  geom_point(size = 2) + geom_line(size = 1.5) +
  geom_point(aes(Fiscal_Mo,Fiscal_Mo_QTY),size = 2,colour='green') + 
  geom_line(aes(Fiscal_Mo,Fiscal_Mo_QTY),size = 1.5,colour='green') +
  labs(title = 'HDD Monthly Sales Forecast vs Ground Truth', x = "Fiscal Month", y = "Part Quantity") + 
  # theme_minimal(base_size = 18) + # for slides
  theme_minimal() + 
  scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY17M01','FY18M01','FY18M07','FY19M01')) +
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
p_HDDMonth_Forecast

```


```{r Facebook Prophet Monthly Forecasting with mannual cross validation}
HDD_data %>% group_by(Fiscal_Mo) %>%
  mutate(Fiscal_Mo_QTY=sum(QTY)) -> HDD_Monthly

# Convert date format
df0 <- na.omit(unique(data.frame(ds0 = HDD_Monthly$Fiscal_Mo, ds = as.Date(HDD_Monthly$Fiscal_Mo_End_Date,format = "%m/%d/%Y"), y = HDD_Monthly$Fiscal_Mo_QTY)))
# ds0 = HDD_Monthly$Fiscal_Mo, used to confirm the Month info and used to plot later.

# But Prophet only takes df.
df <- na.omit(unique(data.frame(ds = as.Date(HDD_Monthly$Fiscal_Mo_End_Date,format = "%m/%d/%Y"), y = HDD_Monthly$Fiscal_Mo_QTY)))


forecastPeriodLen = 6
k <- 18
n <- nrow(df)

mape<- matrix(NA,n-k-forecastPeriodLen+1,n-k)
colnames(mape) <- c('FY18M07','FY18M08','FY18M09','FY18M10','FY18M11','FY18M12','FY19M01','FY19M02','FY19M03')


HDDMonth_Forecast <- matrix(NA,n-k-forecastPeriodLen+1,n-k)
colnames(HDDMonth_Forecast) <-   c('FY18M07','FY18M08','FY18M09','FY18M10','FY18M11','FY18M12','FY19M01','FY19M02','FY19M03')

freq <- 12

for(i in 1:(n-k-forecastPeriodLen+1))
{
  xshort <- filter(df,ds<=df$ds[i+k-1])
  xnext <- filter(df,ds>df$ds[i+k-1] & ds<=df$ds[i+k-1+forecastPeriodLen])
 
  m <- prophet(xshort,  yearly.seasonality = TRUE)
  future <- make_future_dataframe(m, periods = 6, freq = 'month',include_history = FALSE)
  fcast <- predict(m, future)
  #plot(m, forecast, ylim = c(0, 1000000))
  
  mape[i,] <- c(rep(NA,i-1),abs(fcast$yhat-xnext$y)/xnext$y*100,rep(NA,n-k-(i-1)-forecastPeriodLen))
  HDDMonth_Forecast[i,] <- c(rep(NA,i-1),fcast$yhat,rep(NA,n-k-(i-1)-forecastPeriodLen))
}

mape <- data.frame(mape)
mape$ForecastTimePoint <- c('FY18M07','FY18M08','FY18M09','FY18M10')
mape %>% gather(key='Fiscal_Mo',value="HDD_forecast",FY18M07:FY19M03) -> mape

p_mape <- mape %>% 
  ggplot(aes(x=Fiscal_Mo,y=HDD_forecast,group=ForecastTimePoint, colour=ForecastTimePoint)) +
  geom_point(size = 2) +
  geom_line(size = 1.5) +
  labs(title = 'HDD Monthly Sales Forecast Errors', x = "Fiscal Month", y = "MAPE (%)") + 
  # theme_minimal(base_size = 18) + # for slides
  theme_minimal() +
  scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY18M07', 'FY18M10','FY19M01')) +
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
p_mape

HDDMonth_Forecast <- data.frame(HDDMonth_Forecast)
HDDMonth_Forecast$ForecastTimePoint <- c('FY18M07','FY18M08','FY18M09','FY18M10')
HDDMonth_Forecast %>% 
  gather(key='Fiscal_Mo',value="HDD_forecast",FY18M07:FY19M03) -> HDDMonth_Forecast

HDD_data %>% group_by(Fiscal_Mo) %>%
  summarise(Fiscal_Mo_QTY=sum(QTY)) -> temp_monthly
HDDMonth_Forecast %>% full_join(temp_monthly) -> HDDMonth_Forecast

p_HDDMonth_Forecast <- HDDMonth_Forecast %>% 
  ggplot(aes(x=Fiscal_Mo,y=HDD_forecast,group=ForecastTimePoint, colour=ForecastTimePoint)) +
  geom_point(size = 2) + geom_line(size = 1.5) +
  geom_point(aes(Fiscal_Mo,Fiscal_Mo_QTY),size = 2,colour='green') + 
  geom_line(aes(Fiscal_Mo,Fiscal_Mo_QTY),size = 1.5,colour='green') +
  labs(title = 'HDD Monthly Sales Forecast vs Ground Truth', x = "Fiscal Month", y = "Part Quantity") + 
  # theme_minimal(base_size = 18) + # for slides
  theme_minimal() + 
  scale_color_tableau('tableau10medium') + 
  scale_x_discrete(breaks = c('FY17M01','FY18M01','FY18M07','FY19M01')) +
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)
p_HDDMonth_Forecast
```



```{r Facebook Prophet Monthly Forecasting}
HDD_data %>% group_by(Fiscal_Mo) %>%
  mutate(Fiscal_Mo_QTY=sum(QTY)) -> HDD_Monthly

# Convert date format
df0 <- na.omit(unique(data.frame(ds0 = HDD_Monthly$Fiscal_Mo, ds = as.Date(HDD_Monthly$Fiscal_Mo_End_Date,format = "%m/%d/%Y"), y = HDD_Monthly$Fiscal_Mo_QTY)))
# ds0 = HDD_Monthly$Fiscal_Mo, used to confirm the Month info and used to plot later.

# But Prophet only takes df.
df <- na.omit(unique(data.frame(ds = as.Date(HDD_Monthly$Fiscal_Mo_End_Date,format = "%m/%d/%Y"), y = HDD_Monthly$Fiscal_Mo_QTY)))

# We call the prophet function to fit the model. The first argument is the historical dataframe. Additional arguments control how Prophet fits the data and are described in later pages of this documentation.
m <- prophet(df)

future <- make_future_dataframe(m, periods = 6, freq = 'month')
tail(future)

forecast <- predict(m, future)
tail(forecast[c('ds', 'yhat', 'yhat_lower', 'yhat_upper')])

plot(m, forecast, ylim = c(0, 1000000)) # "ylim" does not work.

# prophet_plot_components(m, forecast)

df.cv <- cross_validation(m, horizon =365/2, units = 'days', period = 30)

df.cv %>%
  ggplot(aes(x=ds,y=abs(y-yhat)/y*100)) +
  geom_point(size = 2) + geom_line(size = 1.5) +
  labs(title = 'HDD Monthly Sales Forecast Errors', x = "Fiscal Month End Date", y = "MAPE (%)") + 
  # theme_minimal(base_size = 18) + # for slides
  theme_minimal() + 
  scale_color_tableau('tableau10medium') + 
  # scale_x_discrete(breaks = c('FY17M01','FY18M01','FY18M07','FY19M01')) +
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)

df.cv %>% gather(key='yFlag',value="HDD_QTY",y:yhat) -> df.cv

df.cv %>%
  ggplot(aes(x=ds,y=HDD_QTY,colour=yFlag,group=yFlag)) +
  geom_point(size = 2) + geom_line(size = 1.5) +
  labs(title = 'HDD Monthly Sales Forecast vs Ground Truth', x = "Fiscal Month End Date", y = "Part Quantity") + 
  # theme_minimal(base_size = 18) + # for slides
  theme_minimal() + 
  scale_color_tableau('tableau10medium') + 
  # scale_x_discrete(breaks = c('FY17M01','FY18M01','FY18M07','FY19M01')) +
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)

# I think there must be something wrong with the cross_validation, but it turned out to be that Prophet may just not work for monthly data since there are limited number of data points.
```


```{r Facebook Prophet Weekly Forecasting}
HDD_data %>% group_by(Fiscal_Wk) %>%
  mutate(Fiscal_Wk_QTY=sum(QTY)) -> HDD_Weekly

# Convert date format
df <- na.omit(unique(data.frame(ds = as.Date(HDD_Weekly$Fiscal_Wk_End_Date,format = "%m/%d/%Y"), y = HDD_Weekly$Fiscal_Wk_QTY)))
# ds0 = HDD_Monthly$Fiscal_Mo, used to confirm the Month info

# We call the prophet function to fit the model. The first argument is the historical dataframe. Additional arguments control how Prophet fits the data and are described in later pages of this documentation.
m <- prophet(weekly.seasonality=FALSE)
m <- add_seasonality(m, name='monthly', period=30.5, fourier.order=5)
m <- prophet(df)

future <- make_future_dataframe(m, periods = 48, freq = 'week')
tail(future)

forecast <- predict(m, future)
tail(forecast[c('ds', 'yhat', 'yhat_lower', 'yhat_upper')])

plot(m, forecast, 
    ylim = c(0, 1000000))

prophet_plot_components(m, forecast)

df.cv <- cross_validation(m, horizon = 356/2, units = 'days')

df.cv %>%
  ggplot(aes(x=ds,y=abs(y-yhat)/y*100)) +
  geom_point(size = 2) + geom_line(size = 1.5) +
  labs(title = 'HDD Weekly Sales Forecast Errors', x = "Fiscal Week End Date", y = "MAPE (%)") + 
  # theme_minimal(base_size = 18) + # for slides
  theme_minimal() + 
  scale_color_tableau('tableau10medium') + 
  # scale_x_discrete(breaks = c('FY17M01','FY18M01','FY18M07','FY19M01')) +
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)

df.cv %>% gather(key='yFlag',value="HDD_QTY",y:yhat) -> df.cv

df.cv %>%
  ggplot(aes(x=ds,y=HDD_QTY,colour=yFlag,group=yFlag)) +
  geom_point(size = 2) + geom_line(size = 1.5) +
  labs(title = 'HDD Weekly Sales Forecast vs Ground Truth', x = "Fiscal Week End Date", y = "Part Quantity") + 
  # theme_minimal(base_size = 18) + # for slides
  theme_minimal() + 
  scale_color_tableau('tableau10medium') + 
  # scale_x_discrete(breaks = c('FY17M01','FY18M01','FY18M07','FY19M01')) +
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(label=comma) + expand_limits(y = 0)

```
