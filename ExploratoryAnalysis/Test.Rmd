---
title: "Test"
author: "Yao"
date: "May 22, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(ggplot2)
```

## Load Database

```{r ConnectDB}
library(DBI)
db = dbConnect(odbc::odbc(),
               driver = 'SQL Server',
               server = 'IRISAGL01.aus.amer.dell.com',
               user = 'Yao_Z',
               password = 'y67uhgt@Y')
```

```{sql connection=db, output.var ="isgOrders.top100"}
SELECT TOP 100 *
FROM IRIS.[Base].[ISG_Business_Transformation.isgOrders]
```

1. Query using DBI
You can query your data with DBI by using the dbGetQuery function. Simply paste your SQL code into the R function as a quoted string. This method is sometimes referred to as pass through SQL code, and is probably the simplest way to query your data. Care should be used to escape your quotes as needed. For example, 'yes' is written as \'yes\'.
```{r DataQuery1}
isgOrders.top10 <- dbGetQuery(db,'
  SELECT TOP 10 *
  FROM IRIS.[Base].[ISG_Business_Transformation.isgOrders]
')
```

2. Query using dplyr syntax
You can write your code in dplyr syntax, and dplyr will translate your code into SQL. There are several benefits to writing queries in dplyr syntax: You can keep the same consistent language both for R objects and database tables; no knowledge of SQL or the specific SQL variant is required; and you can take advantage of the fact that dplyr is lazy in its evaluation. dplyr syntax is easy to read, but you can always inspect the SQL translation with the show_query function.
```{r Dataquery2, eval=FALSE, include=FALSE}
# this does not work on my PC
con <- dbConnect(odbc::odbc(), "Oracle DB")
q1 <- tbl(con, "bank") %>%
  group_by(month_idx, year, month) %>%
  summarise(
    subscribe = sum(ifelse(term_deposit == "yes", 1, 0)),
    total = n())
show_query(q1)
```

3. Query using an R Notebooks
It is not well known that you can run SQL code in an R Notebook code chunk. To use SQL, open an R Notebook in the RStudio IDE under the File > New File menu. Start a new code chunk with {sql}, and specify your connection with the connection=con code chunk option. If you want to send the query output to an R dataframe use output.var = "mydataframe" in the code chunk options. When you specify output.var you will be able to use the output in subsequent R code chunks. In this example, we use the output in ggplot.
```{sql connection=db, output.var ="Sys_num_FY2019_orders"}
SELECT Order_Date_week, SUM(SYS_QTY_DELL) AS SYS_QTY_DELL
FROM IRIS.[Base].[ISG_Business_Transformation.isgOrders]
WHERE Order_Date_Year = 'FY2019' AND DELL_EMC_ORDER_FLAG = 'DELL' AND (LOB_DESC IN ('PowerEdge','Cloud Products') OR MGMT_PROD_LVL_3_NM = 'Storage')
GROUP BY Order_Date_week
ORDER BY Order_Date_week
```

```{r}
p1 <- Sys_num_FY2019_orders %>% ggplot(aes(x=Order_Date_week, y=SYS_QTY_DELL,group=1)) +
  geom_point() + geom_line()
  ggtitle("Sys_num_FY2019_orders")
p1
p2 <- ggplotly(p1)
p2

# Create a shareable link to your chart
# Set up API credentials: https://plot.ly/r/getting-started
# chart_link = plotly_POST(p, filename="geom_point/stat-summary")


```

